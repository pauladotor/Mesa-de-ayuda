name: CI/CD Pipeline - Mesa de Ayuda

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  # Job 1: Continuous Integration (CI)
  test:
    name: ğŸ§ª Tests y ValidaciÃ³n
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3

    - name: ğŸ˜ Configurar PHP 8.1
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, json, mysqli
        coverage: none

    - name: âœ… Verificar versiÃ³n de PHP
      run: |
        php -v
        php -m

    - name: ğŸ” Validar sintaxis PHP
      run: |
        echo "Validando sintaxis de archivos PHP..."
        find TecDesarrollo -name "*.php" -exec php -l {} \; 2>&1 | tee php-lint.log
        if grep -q "Parse error" php-lint.log; then
          echo "âŒ Errores de sintaxis encontrados"
          exit 1
        else
          echo "âœ… Sintaxis vÃ¡lida en todos los archivos PHP"
        fi

    - name: ğŸ§ª Ejecutar pruebas del CRUD
      run: |
        cd TecDesarrollo
        echo "Ejecutando archivos PHP de prueba..."
        if [ -f "test_cicd.php" ]; then
          php test_cicd.php
        fi
        echo "âœ… Pruebas completadas"

    - name: ğŸ“Š Generar reporte
      if: always()
      run: |
        echo "=== REPORTE DE CI ===" > ci-report.txt
        echo "Fecha: $(date)" >> ci-report.txt
        echo "Commit: ${{ github.sha }}" >> ci-report.txt
        echo "Branch: ${{ github.ref_name }}" >> ci-report.txt
        cat ci-report.txt

  # Job 2: Continuous Deployment (CD)
  deploy:
    name: ğŸš€ Despliegue a Render
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3

    - name: ğŸš€ Desplegar a Render
      env:
        RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK" ]; then
          echo "âš ï¸ RENDER_DEPLOY_HOOK no configurado"
          exit 1
        fi
        
        echo "ğŸš€ Iniciando despliegue en Render..."
        response=$(curl -X POST "$RENDER_DEPLOY_HOOK")
        echo "Respuesta de Render: $response"
        echo "âœ… Despliegue iniciado correctamente"

    - name: âœ… NotificaciÃ³n de despliegue
      run: |
        echo "==================================="
        echo "ğŸ‰ DESPLIEGUE COMPLETADO"
        echo "Commit: ${{ github.sha }}"
        echo "Autor: ${{ github.actor }}"
        echo "Mensaje: ${{ github.event.head_commit.message }}"
        echo "==================================="

  # Job 3: VerificaciÃ³n Post-Despliegue
  verify:
    name: ğŸ” Verificar Despliegue
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: â³ Esperar a que Render procese el despliegue
      run: sleep 30

    - name: ğŸŒ Verificar que el sitio responde
      env:
        RENDER_URL: ${{ secrets.RENDER_URL }}
      run: |
        if [ -z "$RENDER_URL" ]; then
          echo "âš ï¸ RENDER_URL no configurado, omitiendo verificaciÃ³n"
          exit 0
        fi
        
        echo "Verificando $RENDER_URL..."
        response=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_URL")
        
        if [ "$response" -eq 200 ] || [ "$response" -eq 301 ] || [ "$response" -eq 302 ]; then
          echo "âœ… Sitio web respondiendo correctamente (HTTP $response)"
        else
          echo "âš ï¸ Sitio web responde con cÃ³digo HTTP $response"
        fi
